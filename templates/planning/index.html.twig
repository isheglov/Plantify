<!DOCTYPE html>
<html lang="ru">
<head>
    <title>Plantify</title>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="../../css/style.css">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
</head>
<body>
    <div id="dialog-form" title="Что дальше сажать">
        <form>
            <fieldset>
                    {% for plant in plantList %}
                        <div class="modal-item">
                            <input type="checkbox" id="checked_{{ plant.id }}" name="plant_chb" value="screen" class="checkbox">
                            <label for="checked_{{ plant.id }}" class="label">{{ plant.name }}</label>
                            <select name="cell" id="cell_amount_{{ plant.id }}" class="select">
                                <option value="1">1 грядка</option>
                                <option value="2">2 грядки</option>
                                <option value="3">3 грядки</option>
                                <option value="4">4 грядки</option>
                                <option value="5">5 грядок</option>
                                <option value="6">6 грядок</option>
                                <option value="7">7 грядок</option>
                                <option value="8">8 грядок</option>
                                <option value="9">9 грядок</option>
                                <option value="10">10 грядок</option>
                            </select>
                        </div>
                    {% endfor %}
                <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
            </fieldset>
        </form>
    </div>

    <div class="nav-bar">
        <div>
            <button class='nav-bar-item' id="suggestion">Что дальше сажать</button>
        </div>
        <div>
            <a class='nav-bar-item' href="/">На главную</a>
        </div>
    </div>

    <h1 class="title">Планирование посадок</h1>

    <div>
        <h2 id="t">Схема участка</h2>
        <table>
            {% for i in 0..dimensionY-1 %}
                <tr>
                    {% for j in 0..dimensionX-1 %}
                        <td id="cell{{ gardenCellList[j][i]['cellId'] }}">
                            <div class="cell-content{{ gardenCellList[j][i]['cellId'] }} cell-content">
                                <h4>{{ gardenCellList[j][i]['plantName'] }}</h4>
                            </div>
                        </td>
                    {% endfor %}
                </tr>
            {% endfor %}
        </table>
    </div>

    <script>
        jQuery( function() {
            var clickedId;
            var dialog, form, combined;

            function setPlant() {
                let jsonText = '{ "plantList" : [';
                jQuery( "[name^=plant_chb]:checked ").each(function addCombinedSuggestion (index) {
                    let plantId = $($( this )[0]).attr('id').replace('checked_','');
                    let plantAmount = $("#cell_amount_"+plantId).val();

                    jsonText += '{ "plantId":'+plantId+', "plantAmount":'+plantAmount+' },';
                });
                jsonText = jsonText.substring(0,jsonText.length - 1);
                jsonText += ']}';

                let obj = JSON.parse(jsonText);

                // console.log(obj);

                $.ajax({
                    url: '/planning',
                    type: 'POST',
                    data: jsonText,
                    success: function(planMap) {

                        // result = '{"map":[{"cellId":172,"plantId":12,"plantName":"Укроп","priority":4}]}';

                        console.log(planMap);
                        var i = 0;
                        planMap.map.forEach(function (item) {
                            let cell = $('.cell-content'+item.cellId);
                            cell.append(
                                '<div class="suggestion-item">' +
                                '<input name="suggestion-radio-'+item.cellId+'" type="radio" id="suggestion-radio-'+item.cellId+'-'+i+'"/>' +
                                '<label for="suggestion-radio-'+item.cellId+'-'+i+'" style="color:green">'+item.plantName+'</label>' +
                                '</div>'
                            );
                            i++;
                        });

                        var cellList = new Array();
                        planMap.map.forEach(function (item) {
                            cellList[item.cellId] = 1;
                        });

                        console.log(cellList);
                        cellList.forEach(function (item, index) {
                            let cell = $('.cell-content'+index);
                            cell.append('<button id="save-btn-'+index+'">сохранить</button>');
                        });

                    }
                });

                dialog.dialog( "close" );
            }

            function parseCompanionsJson(json) {
                json.forEach(addCombinedSuggestion);

                function addCombinedSuggestion (item) {
                    const companionList = item.companionList.join(', ');

                    let text = "<div>Для <strong>"+item.plant+"</strong> подходит "+companionList+".</div>";
                    $("#combined-suggestion").append(text);
                }
            }

            dialog = jQuery( "#dialog-form" ).dialog({
                autoOpen: false,
                height: 400,
                width: 350,
                modal: true,
                buttons: {
                    "Сохранить": setPlant,
                    Cancel: function() {
                        dialog.dialog( "close" );
                    }
                },
                close: function() {
                    form[ 0 ].reset();
                }
            });


            form = dialog.find( "form" ).on( "submit", function( event ) {
                event.preventDefault();
                setPlant();
            });

            jQuery( "[id=suggestion]" ).on( "click", function() {
                dialog.dialog( "open" );
                console.log($(this).data());
                clickedId = 'cell' + $(this).data().cellid;
            });

        } );
    </script>
</body>
</html>
